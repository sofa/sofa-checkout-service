/**
 * sofa-checkout-service - v0.8.0 - Tue Feb 17 2015 13:59:52 GMT+0100 (CET)
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO)
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(e,t,r){"use strict";e.define("sofa.CheckoutService",function(n,a,o,i,s){var c,d,u,l={},h={"Content-Type":"application/x-www-form-urlencoded"},p=s.get("checkoutUrl"),m=s.get("checkoutUrl")+"ajax.php",g=null;e.observable.mixin(l),l.createQuoteData=function(){var e=o.getItems().map(function(e){return{productID:e.product.id+"",qty:e.quantity,variantID:e.getVariantID(),optionID:e.getOptionID()}});return e};var y=function(t){if(!t)return null;var r=e.Util.clone(t);r.addressEqual&&(r.shippingAddress=e.Util.clone(r.billingAddress));var n={},a=function(t){t&&t.birthday&&t.birthmonth&&t.birthyear&&(t.birthdate=e.utils.FormatUtils.zeroFill(t.birthyear,4)+"-"+e.utils.FormatUtils.zeroFill(t.birthmonth,2)+"-"+e.utils.FormatUtils.zeroFill(t.birthday,2),delete t.birthday,delete t.birthmonth,delete t.birthyear)};a(r.billingAddress),a(r.shippingAddress),r.billingAddress&&r.billingAddress.country&&(r.billingAddress.countryLabel=r.billingAddress.country.label,r.billingAddress.country=r.billingAddress.country.value,n.invoiceAddress=JSON.stringify(r.billingAddress)),r.shippingAddress&&r.shippingAddress.country&&(r.shippingAddress.countryLabel=r.shippingAddress.country.label,r.shippingAddress.country=r.shippingAddress.country.value,n.shippingAddress=JSON.stringify(r.shippingAddress)),n.paymentMethod=r.selectedPaymentMethod&&r.selectedPaymentMethod.method?r.selectedPaymentMethod.method:r.selectedPaymentMethod,r.selectedShippingMethod&&r.selectedShippingMethod.method&&(n.shippingMethod=r.selectedShippingMethod.method),n.quote=JSON.stringify(l.createQuoteData()),r.payone&&r.payone.pseudocardpan&&r.payone.truncatedcardpan&&(n.payonePseudocardpan=r.payone.pseudocardpan,n.payoneTruncatedcardpan=r.payone.truncatedcardpan);var i=o.getActiveCoupons().map(function(e){return e.code});return n.coupons=JSON.stringify(i),n};l.getLastUsedPaymentMethod=function(){return c||null},l.getLastUsedShippingMethod=function(){return d||null},l.getShippingMethodsForPayPal=function(e){var t={billingAddress:{country:e||s.getDefaultCountry()},shippingAddress:{country:e||s.getDefaultCountry()},selectedPaymentMethod:"paypal_express"};return l.getSupportedCheckoutMethods(t)},l.getSupportedCheckoutMethods=function(t){var r=y(t);return r.task="GETPAYMENTMETHODS",e.Util.isObject(t.selectedPaymentMethod)&&(c=t.selectedPaymentMethod),e.Util.isObject(t.selectedShippingMethod)&&(d=t.selectedShippingMethod),n({method:"POST",url:m,headers:h,transformRequest:cc.Util.toFormData,data:r}).then(function(t){var r=null;return t.data&&(r=e.Util.toJson(t.data),r&&(r.paymentMethods=r.paymentMethods.map(function(e){return e.surcharge=parseFloat(e.surcharge),e.surcharge_percentage&&(e.surcharge_percentage=parseFloat(e.surcharge_percentage)),e}),r.shippingMethods=r.shippingMethods.map(function(e){return e.price=parseFloat(e.price),e}))),r},function(e){return i.error(["[CheckoutService: getSupportedCheckoutMethods]","[Request Data]",t,"[Service answer]",e]),a.reject(e)})};var f=function(){var e=a.defer(),r=t.createElement("script");r.type="text/javascript",r.async=!0,r.src="https://assets.braintreegateway.com/v2/braintree.js",r.onload=function(){e.resolve()};var n=t.getElementsByTagName("script")[0];return n.parentNode.insertBefore(r,n),e.promise},v=function(e,t){var r=a.defer(),n=new window.braintree.api.Client({clientToken:e});return n.tokenizeCard({number:t.number,expirationMonth:t.expirationMonth,expirationYear:t.expirationYear,cvv:t.cvv},function(e,t){e?r.reject(e):r.resolve(t)}),r.promise};l.checkoutWithCouchCommerce=function(t){t.addressEqual&&(t.shippingAddress=t.billingAddress);var r=y(t);return r.task="CHECKOUT",a.when().then(function(){return"braintree_creditcard"===t.selectedPaymentMethod.method?n({method:"POST",headers:h,url:m,transformRequest:cc.Util.toFormData,data:{task:"BRAINTREETOKEN"}}).then(function(e){var t=e.data.token;return window.braintree?a.when(t):f().then(function(){return a.when(t)})}).then(function(e){return v(e,{number:t.braintree.creditcardnumber.replace(/ /g,""),cvv:t.braintree.creditcardcvc2,expirationMonth:t.braintree.creditcardexpirationmonth.value,expirationYear:2e3+t.braintree.creditcardexpirationyear.value}).then(function(e){r.braintreeNonce=e})}):a.when()}).then(function(){return n({method:"POST",url:m,headers:h,transformRequest:cc.Util.toFormData,data:r})}).then(function(t){var r=null;return t.data&&(r=e.Util.toJson(t.data),r=r.token||null),r},function(e){return i.error(["[CheckoutService: checkoutWithCouchCommerce]","[Request Data]",t,"[Service answer]",e]),a.reject(e)})},l.checkoutWithPayPal=function(e,t){var r={selectedShippingMethod:e,selectedPaymentMethod:{method:"paypal"},shippingAddress:{country:t},billingAddress:{country:t}},o=y(r);return o.task="UPDATEQUOTEPP",n({method:"POST",url:m,headers:h,transformRequest:cc.Util.toFormData,data:o}).then(function(e){return 1!=e.data?a.reject(new Error("invalid server response")):void(window.location.href=s.get("checkoutUrl"))}).then(null,function(e){return i.error(["[CheckoutService: checkoutWithPayPal]","[Request Data]",o,"[Service answer]",e]),a.reject(e)})};var b=function(e){return e===r||null===e?"":e},A=function(e){e=e||{};var t={value:b(e.country),label:b(e.countryname)};return{company:b(e.company),salutation:b(e.salutation),surname:b(e.lastname),name:b(e.firstname),street:b(e.street),streetnumber:b(e.streetnumber),streetextra:b(e.streetextra),zip:b(e.zip),city:b(e.city),country:t.value?t:null,email:b(e.email),telephone:b(e.telephone)}},S=function(e){return e=e||{},{sum:b(e.subtotal),shipping:b(e.shipping),surcharge:b(e.surcharge),vat:b(e.vat),total:b(e.grandtotal)}};return l.getSummary=function(t){return n({method:"POST",url:p+"summaryst.php",headers:h,transformRequest:cc.Util.toFormData,data:{details:"get",token:t}}).then(function(r){var n={};return n.response=e.Util.toJson(r.data),n.invoiceAddress=A(n.response.billing),n.shippingAddress=A(n.response.shipping),n.summary=S(n.response.totals),n.token=t,u=n,g=n.response.redirect?{token:t,redirect:n.response.redirect}:null,n})},l.getLastSummary=function(){return u},l.activateOrder=function(t){if(g&&g.token===t)return void(window.location.href=s.get("checkoutUrl")+g.redirect+"?token="+t);var r="PAYONE_CREDIT_CARD"===u.response.paymentMethodName,o=r?s.get("checkoutUrlNew")+"orders":p+"docheckoutst.php";return n({method:"POST",url:o,headers:h,transformRequest:cc.Util.toFormData,data:{details:"get",token:t,storeCode:s.get("storeCode")}}).then(function(t){if(r)return t.data.error?a.reject(t.data.error):t.data.redirectUrl?void(window.location.href=t.data.redirectUrl):t.data;var n=e.Util.toJson(t.data);return n},function(e){return i.error(["[CheckoutService: checkoutWithCouchCommerce]","[Request Data]",t,"[Service answer]",e]),a.reject(e)})},l}),e.define("sofa.utils.FormatUtils",{zeroFill:function(e,t){return t-=e.toString().length,t>0?new Array(t+(/\./.test(e)?2:1)).join("0")+e:e+""}})}(sofa,document);