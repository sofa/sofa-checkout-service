/**
 * sofa-checkout-service - v0.7.0 - 2015-01-12
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a){"use strict";a.define("sofa.CheckoutService",function(b,c,d,e,f,g,h){var i={},j=null,k=f.get("checkoutEndpoint"),l="paymentMethod",m="shippingMethod",n=new a.checkout.DefaultQuoteRequester(c),o=new a.checkout.FlowRouter;i.getLastUsedPaymentMethod=function(){return null},i.getLastUsedShippingMethod=function(){return null},i.hasExistingBillingAddress=function(){return h.hasExistingBillingAddress()},i.getShippingAddress=function(){return h.getShippingAddress()},i.updateShippingAddress=function(a){h.updateShippingAddress(a)},i.getBillingAddress=function(){return h.getBillingAddress()},i.updateBillingAddress=function(a){h.updateBillingAddress(a)},i.getPaymentMethod=function(){return g.get(l)},i.updatePaymentMethod=function(a){g.set(l,a)},i.getShippingMethod=function(){return g.get(m)},i.updateShippingMethod=function(a){g.set(m,a)},i.getPaymentMethodByCode=function(b,c){return a.Util.find(c,function(a){return a.code&&a.code===b})||{}},i.getCleanCheckoutModel=function(){return{billingAddress:{},shippingAddress:{},items:[]}},i.getAvailableCheckoutMethods=function(c){return c.items=d.getItems().map(function(a){return{productId:a.product.id,quantity:a.quantity,variant:a.getVariantID()&&{id:a.getVariantID()},option:a.getOptionID()&&{id:a.getOptionID()}}}),b({method:"POST",url:k+"/methods",data:c}).then(function(b){return b.data.paymentMethods=a.utils.FormatUtils.toSofaPaymentMethods(b.data.paymentMethods),b.data.shippingMethods=a.utils.FormatUtils.toSofaShippingMethods(b.data.shippingMethods),b.data})},i.addFlow=function(a){o.addFlow(a)},i.addFlows=function(a){o.addFlows(a)},i.createQuote=function(b){var c=p(a.Util.clone(b)),d=o.matchFlow(c);return d.createQuote(c).then(function(a){return j=a,j.cached=!0,a})},i.updateQuote=function(b){var c=p(a.Util.clone(b)),d=o.matchFlow(c);return d.updateQuote(c).then(function(a){return j=a,j.cached=!0,a})};var p=function(b){return b.billingAddress&&b.billingAddress.country&&(b.billingAddress.country=b.billingAddress.country.value),b.shippingAddress&&b.shippingAddress.country&&(b.shippingAddress.country=b.shippingAddress.country.value),b.addressEqual&&a.Util.isEmpty(b.shippingAddress)?b.shippingAddress=b.billingAddress:b.addressEqual&&a.Util.isEmpty(b.billingAddress)&&(b.billingAddress=b.shippingAddress),b.items=d.getItems().map(function(a){return{productId:a.product.id+"",quantity:a.quantity}}),b};return i.getQuote=function(a){return n.getQuote(a,j)},i.createOrder=function(a){return orderRequester.getOrder(a)},i}),a.define("sofa.checkout.flows.DefaultFlow",function(a,b,c){var d={},e=a.get("checkoutEndpoint");return d.initialize=function(){},d.createQuote=function(a){return c({method:"POST",url:e+"/quotes",data:a}).then(function(a){var b={quote:a.data,token:a.headers("X-Auth-Token")};return b})},d.updateQuote=function(){},d}),a.define("sofa.checkout.flows.DummyFlow",function(a){var b={};return b.initialize=function(){},b.createQuote=function(){var b=a.defer();return b.resolve({token:"4711",quote:{id:4712}}),b.promise},b.updateQuote=function(){},b}),a.define("sofa.checkout.DefaultOrderRequester",function(a){var b=this;return b.getOrder=function(){var b=a.defer();return b.resolve({token:"4711",order:{id:4712}}),b.promise},b}),a.define("sofa.checkout.DefaultQuoteRequester",function(a){var b=this;return b.getQuote=function(b,c){if(c&&c.token==b.token&&c.quote.id==b.id)return a.when(c);var d=a.defer();return d.resolve({token:"4711",quote:{id:4712}}),d.promise},b}),a.define("sofa.checkout.FlowRouter",function(){var b={},c=[];return b.addFlow=function(a){c.push(a)},b.addFlows=function(a){a=a},b.matchFlow=function(b){var d=a.Util.find(c,function(a){return a.predicate(b)});return d?d.flow:null},b}),a.define("sofa.utils.FormatUtils",{zeroFill:function(a,b){return b-=a.toString().length,b>0?new Array(b+(/\./.test(a)?2:1)).join("0")+a:a+""}})}(sofa);