/**
 * sofa-checkout-service - v0.6.0 - 2015-03-10
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a){"use strict";a.define("sofa.CheckoutService",function(b,c,d,e,f){var g,h,i={},j={},k=new a.checkoutservice.CheckoutMethodsRequestConverter(j),l=new a.checkoutservice.CheckoutMethodsRequester(c,b,f,j),m=new a.checkoutservice.CheckoutRequestConverter(j),n=new a.checkoutservice.CheckoutRequester(c,b,f,j),o=new a.checkoutservice.QuoteToOrderRequester(c,b,f,j),p=new a.checkoutservice.QuoteRequester(c,b,f,j),q=new a.checkoutservice.OrderRequester(c,b,f,j);a.observable.mixin(i),i.createQuoteData=function(){throw new Error("not implemented")},i.getLastUsedPaymentMethod=function(){return g||null},i.getLastUsedShippingMethod=function(){return h||null},i.getShippingMethodsForPayPal=function(){throw new Error("not implemented")},i.getSupportedCheckoutMethods=function(b){var f=k(r(b),d.getItems());return a.Util.isObject(b.selectedPaymentMethod)&&(g=b.selectedPaymentMethod),a.Util.isObject(b.selectedShippingMethod)&&(h=b.selectedShippingMethod),l(f).then(null,function(a){return e.error(["[CheckoutService: getSupportedCheckoutMethods]","[Request Data]",f,"[Service answer]",a]),c.reject(a)})},i.checkout=function(a){var b=m(r(a),d.getItems());return n(b).then(null,function(a){return e.error(["[CheckoutService: getSupportedCheckoutMethods]","[Request Data]",b,"[Service answer]",a]),c.reject(a)})};var r=function(b){var c=a.Util.clone(b);return c.addressEqual&&(c.shippingAddress=c.billingAddress),c};return i.getQuote=function(a){return p(a)},i.getOrder=function(a){return q(a)},i.placeOrder=function(a){return o(a).then(null,function(b){return e.error(["[CheckoutService: placeOrder]","[Request Data]",a,"[Service answer]",b]),c.reject(b)})},i}),a.define("sofa.checkoutservice.CheckoutMethodsRequestConverter",function(){var b=function(b,c,d){a.Util.isNotNullNorUndefined(d)&&(b[c]=d)};return function(c,d){var e=d.map(function(a){return{productId:a.product.id,quantity:a.quantity,variant:a.getVariantID()&&{id:a.getVariantID()},option:a.getOptionID()&&{id:a.getOptionID()}}}),f={};return c.billingAddress&&(f.billingAddress=a.utils.FormatUtils.toBackendAddress(c.billingAddress),f.shippingAddress=a.utils.FormatUtils.toBackendAddress(c.shippingAddress)),b(f,"currency",c.currency),b(f,"payment",c.payment),b(f,"shipping",c.selectedShippingMethod),b(f,"items",e),b(f,"discounts",c.discounts||[]),f}}),a.define("sofa.checkoutservice.CheckoutMethodsRequester",function(b,c,d){var e=d.get("checkoutEndpoint");return function(b){return c({method:"POST",url:e+"/methods",data:b}).then(function(b){return b.data.paymentMethods=a.utils.FormatUtils.toSofaPaymentMethods(b.data.paymentMethods),b.data.shippingMethods=a.utils.FormatUtils.toSofaShippingMethods(b.data.shippingMethods),b.data})}}),a.define("sofa.checkoutservice.CheckoutRequestConverter",function(){return new a.checkoutservice.CheckoutMethodsRequestConverter}),a.define("sofa.checkoutservice.CheckoutRequester",function(b,c,d,e){var f=d.get("checkoutEndpoint");return function(b){return c({method:"POST",url:f+"/quotes",data:b}).then(function(b){var c={order:a.utils.FormatUtils.toSofaQuoteOrOrder(b.data),token:b.headers("X-Auth-Token")};return e.lastOrder=c,c})}}),a.define("sofa.checkoutservice.OrderRequester",function(a,b,c){var d=c.get("checkoutEndpoint");return function(a){return b({method:"GET",headers:{"X-Auth-Token":a.token},url:d+"/orders/"+a.orderId,data:{}}).then(function(a){return a.data})}}),a.define("sofa.checkoutservice.QuoteRequester",function(b,c,d,e){var f=d.get("checkoutEndpoint");return function(d){return e.lastOrder&&e.lastOrder.order.id==d.quoteId&&e.lastOrder.token==d.token?b.when(e.lastOrder.order):c({method:"GET",headers:{"X-Auth-Token":d.token},url:f+"/quotes/"+d.quoteId,data:{}}).then(function(b){return a.utils.FormatUtils.toSofaQuoteOrOrder(b.data)})}}),a.define("sofa.checkoutservice.QuoteToOrderRequester",function(b,c,d){var e=d.get("checkoutEndpoint"),f=function(b,c,d){var e=document.createElement("form");e.method=c,e.action=b,d&&a.Util.forEach(d,function(a,b){var c=document.createElement("input");c.type="text",c.name=b,c.value=a,e.appendChild(c)}),e.submit()};return function(a){return c({method:"POST",headers:{"X-Auth-Token":a.token},url:e+"/quotes/"+a.orderId+"/order",data:{}}).then(function(a){var b={flow:"local_thankyou",data:a.data};return a.data.payment.redirectUrl&&(b.flow="redirect",f(a.data.payment.redirectUrl,"POST",a.data.payment.redirectParameters)),b})}}),a.define("sofa.utils.FormatUtils",{zeroFill:function(a,b){return b-=a.toString().length,b>0?new Array(b+(/\./.test(a)?2:1)).join("0")+a:a+""},toBackendAddress:function(a){return a&&{company:a.company||"",salutation:a.salutation||"",firstName:a.name||"",lastName:a.surname||"",street:a.street||"",streetNumber:a.streetnumber||"",streetAdditional:a.streetextra||"",city:a.city||"",zipCode:a.zip||"",country:a.country&&a.country.value,email:a.email||"",phone:a.telephone||"",vatId:0}},toSofaAddress:function(a){return a&&{company:a.company,salutation:a.salutation,name:a.firstName,surname:a.lastName,street:a.street,streetnumber:a.streetNumber,streetextra:a.streetAdditional,city:a.city,zip:a.zipCode,country:{value:a.country},email:a.email,telephone:a.phone}},toSofaPaymentMethods:function(a){return a.map(function(a){return a.surcharge=a.surcharge/100,a})},toSofaShippingMethods:function(a){return a.map(function(a){return a.price=a.price/100,a.taxAmount=a.taxAmount/100,a})},toSofaQuoteOrOrder:function(b){b.shippingAddress=a.utils.FormatUtils.toSofaAddress(b.shippingAddress),b.billingAddress=a.utils.FormatUtils.toSofaAddress(b.billingAddress),b.allowedPaymentMethods&&(b._allowedPaymentMethods=b.allowedPaymentMethods,b.allowedPaymentMethods=a.utils.FormatUtils.toSofaPaymentMethods(b.allowedPaymentMethods)),b.allowedShippingMethods&&(b._allowedShippingMethods=b.allowedShippingMethods,b.allowedShippingMethods=a.utils.FormatUtils.toSofaShippingMethods(b.allowedShippingMethods));var c=b.totals;return b._totals=c,b._items=b.items,b.items=b.items.map(function(a){return a.price=a.price/100,a.subtotal=a.rowTotal/100,a.qty=a.quantity,a}),b.totals={total:c.grandTotal/100,sum:c.subTotal/100,shipping:c.shippingAmount/100,vat:c.taxTotals[0].taxAmount/100},b.discounts=b.discounts.map(function(a){return{code:a.code,amount:-1*a.price/100,tax:a.taxPercent,name:a.name}}),b}})}(sofa);